
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conexão Eclesia - Chat</title>
    <!-- Incluindo Tailwind CSS para estilização (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluindo a fonte Inter do Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden; /* Evita barras de rolagem no iframe do chat */
            text-size-adjust: none; /* Adicionado para resolver o aviso de text-size-adjust */
            -webkit-text-size-adjust: none; /* Adicionado para resolver o aviso de text-size-adjust */
        }
        /* Oculta a barra de rolagem principal do iframe, mas permite no conteúdo do chat */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
        .chat-messages {
            overflow-y: auto;
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>
    <div id="chat-root"></div>

    <!-- Importa React e ReactDOM a partir de um CDN (unpkg.com) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Importa Babel para transpilar JSX diretamente no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Importa o SDK do Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Carrega o script verificador de instância Supabase (importante para compartilhar a instância) -->
    <script src="supabaseClientInstance.js"></script>

    <!-- O código React/JSX do Chat -->
    <script type="text/babel">
        // Definição do Modal (sem alterações)
        function Modal({ isOpen, message, type, onClose }) {
          if (!isOpen) return null;

          const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
          const headerText = type === 'success' ? 'Sucesso!' : 'Erro!';

          return (
            <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg shadow-xl overflow-hidden max-w-sm w-full transform transition-all duration-300 scale-100">
                <div className={`${bgColor} text-white px-6 py-4 flex justify-between items-center rounded-t-lg`}>
                  <h3 className="text-xl font-bold font-inter">{headerText}</h3>
                  <button
                    onClick={onClose}
                    className="text-white hover:text-gray-200 focus:outline-none text-2xl font-bold"
                    aria-label="Fechar modal de mensagem"
                  >
                    &times;
                  </button>
                </div>
                <div className="p-6">
                  <p className="text-gray-700 text-lg mb-4 font-inter">{message}</p>
                  <div className="flex justify-end">
                    <button
                      onClick={onClose}
                      className={`py-2 px-6 rounded-lg font-bold text-white transition duration-300 shadow-md ${bgColor} hover:${bgColor.replace('500', '600')} focus:outline-none focus:ring-2 focus:ring-opacity-75`}
                      aria-label="Entendido, fechar mensagem"
                    >
                      OK
                    </button>
                  </div>
                </div>
              </div>
            </div>
          );
        }

        // Componente principal do Chat
        function ChatApp() {
            // Inicializa a instância do Supabase globalmente se ainda não foi inicializada
            // Isso garante que window.supabase.createClient esteja disponível
            if (!window.globalSupabaseClient && window.supabase) {
                window.globalSupabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
            }
            // Acessa a instância global do Supabase (agora garantida)
            const supabase = window.globalSupabaseClient;

            const [isOpen, setIsOpen] = React.useState(false);
            const [messages, setMessages] = React.useState([]);
            const [newMessage, setNewMessage] = React.useState('');
            const [userProfile, setUserProfile] = React.useState(null);
            const [isLoadingMessages, setIsLoadingMessages] = React.useState(true);
            const messagesEndRef = React.useRef(null);

            React.useEffect(() => {
                if (!supabase) { // Adiciona verificação para Supabase antes de usar
                    console.error("Supabase client not initialized.");
                    setIsLoadingMessages(false);
                    return;
                }

                const fetchUserDataAndMessages = async () => {
                    setIsLoadingMessages(true);
                    try {
                        const { data: { user } } = await supabase.auth.getUser();
                        if (user) {
                            const { data: profileData, error: profileError } = await supabase
                                .from('profiles')
                                .select('full_name')
                                .eq('id', user.id)
                                .single();

                            if (profileError) {
                                console.error("Erro ao buscar perfil do usuário no chat:", profileError);
                                setUserProfile({ id: user.id, full_name: 'Usuário Desconhecido' });
                            } else {
                                setUserProfile({ id: user.id, full_name: profileData.full_name || 'Usuário' });
                            }
                        } else {
                            setUserProfile(null);
                        }

                        const { data, error } = await supabase
                            .from('messages')
                            .select(`
                                *,
                                profiles (full_name)
                            `)
                            .order('created_at', { ascending: true });

                        if (error) {
                            console.error("Erro ao carregar mensagens:", error);
                        } else {
                            const formattedMessages = data.map(msg => ({
                                ...msg,
                                sender_name: msg.profiles ? msg.profiles.full_name : 'Usuário Desconhecido'
                            }));
                            setMessages(formattedMessages);
                        }
                    } catch (error) {
                        console.error("Erro inesperado ao carregar dados do chat:", error);
                    } finally {
                        setIsLoadingMessages(false);
                    }
                };

                fetchUserDataAndMessages();

                // Configura o Realtime para novas mensagens
                const messagesSubscription = supabase
                    .channel('public:messages')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                        const fetchSenderNameForNewMessage = async () => {
                            const { data: senderProfile, error } = await supabase
                                .from('profiles')
                                .select('full_name')
                                .eq('id', payload.new.sender_id)
                                .single();

                            const senderName = senderProfile ? senderProfile.full_name : 'Usuário Desconhecido';
                            setMessages(prevMessages => [...prevMessages, {
                                ...payload.new,
                                sender_name: senderName
                            }]);
                        };
                        fetchSenderNameForNewMessage();
                    })
                    .subscribe();

                return () => {
                    messagesSubscription.unsubscribe();
                };
            }, [supabase]); // Adiciona supabase às dependências

            React.useEffect(() => {
                if (messagesEndRef.current) {
                    messagesEndRef.current.scrollIntoView({ behavior: "smooth" });
                }
            }, [messages]);

            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (newMessage.trim() === '' || !userProfile) return;

                const { error } = await supabase
                    .from('messages')
                    .insert([
                        {
                            sender_id: userProfile.id,
                            content: newMessage.trim(),
                        }
                    ]);

                if (error) {
                    console.error("Erro ao enviar mensagem:", error);
                } else {
                    setNewMessage('');
                }
            };

            return (
                <div className="fixed bottom-0 right-0 z-50 p-4">
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        className="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition-all duration-300 transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75"
                        aria-label={isOpen ? "Fechar chat" : "Abrir chat"}
                    >
                        {isOpen ? (
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6">
                                <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        ) : (
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6">
                                <path strokeLinecap="round" strokeLinejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H16.5m-1.5 2.25h.75c.414 0 .75.336.75.75s-.336.75-.75.75h-.75zm-9 0h.75c.414 0 .75.336.75.75s-.336.75-.75.75H7.5m9-1.5H15V12a3 3 0 00-3-3H9a3 3 0 00-3 3v1.5h1.5m9-1.5H12a.75.75 0 00-.75.75v.75h.75v.75H12a.75.75 0 00-.75.75v.75H6.75V15m1.5-1.5h.75m4.5 0h.75m3-3h.75m-9 3h.75" />
                            </svg>
                        )}
                    </button>

                    {isOpen && (
                        <div className="bg-white rounded-lg shadow-xl flex flex-col w-72 h-96 fixed bottom-20 right-4">
                            <div className="bg-blue-600 text-white p-3 rounded-t-lg flex justify-between items-center">
                                <h3 className="font-bold text-lg">Chat Global</h3>
                                <button
                                    onClick={() => setIsOpen(false)}
                                    className="text-white hover:text-gray-200 focus:outline-none"
                                    aria-label="Fechar janela do chat"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-5 h-5">
                                        <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>

                            <div className="flex-1 p-3 space-y-2 overflow-y-auto chat-messages">
                                {isLoadingMessages ? (
                                    <div className="text-gray-500 text-center text-sm">Carregando mensagens...</div>
                                ) : messages.length === 0 ? (
                                    <div className="text-gray-500 text-center text-sm">Nenhuma mensagem ainda.</div>
                                ) : (
                                    messages.map((msg, index) => (
                                        <div key={msg.id} className={`flex ${userProfile && msg.sender_id === userProfile.id ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`${userProfile && msg.sender_id === userProfile.id ? 'bg-blue-100 text-blue-800' : 'bg-gray-200 text-gray-800'} p-2 rounded-lg max-w-[80%]`}>
                                                <div className="font-bold text-sm">{msg.sender_name}</div>
                                                <p className="text-sm">{msg.content}</p>
                                                <div className="text-xs text-gray-500 text-right mt-1">{new Date(msg.created_at).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</div>
                                            </div>
                                        </div>
                                    ))
                                )}
                                <div ref={messagesEndRef} />
                            </div>

                            <form onSubmit={handleSendMessage} className="p-3 border-t border-gray-200">
                                <input
                                    type="text"
                                    placeholder={userProfile ? "Digite sua mensagem..." : "Faça login para enviar mensagens..."}
                                    className="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    value={newMessage}
                                    onChange={(e) => setNewMessage(e.target.value)}
                                    disabled={!userProfile}
                                    aria-label={userProfile ? "Campo de texto para digitar mensagem" : "Campo desabilitado. Faça login para digitar."}
                                />
                                <button
                                    type="submit"
                                    className="hidden"
                                    aria-label="Enviar mensagem"
                                >
                                    Enviar
                                </button>
                            </form>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<ChatApp />, document.getElementById('chat-root'));
    </script>
</body>
</html>
